---
title: "Figure2b_Treg7dafterBMT_inVivoDistribution"
author: Michael Rehli
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::write_bib(.packages(), "Figure2b_Treg7dafterBMT_inVivoDistribution.packages.bib")
```

## Bar charts showing the cell counts for re-isolated Treg 

R packages

```{r, message=FALSE, warnings=FALSE}
library(ggplot2)
library(scales)
library(car)
```

data formating 

```{r}
Treg.data <- read.delim("./data/TregDistribution.txt", header=TRUE)
Treg.data$organ <- factor(Treg.data$organ,levels = c("BM","Spleen","Liver","mLN","Colon"))
Treg.data$category <- factor(Treg.data$category,levels = c("organ_resident","allo_noGvHD","allo_GvHD","poly_noGvHD","poly_GvHD"))
```

generating the plot for Figure 2b

```{r, fig.width=9, fig.height=5.5, warning=FALSE}
p <- ggplot(Treg.data, aes(x=category, y=count, fill=category)) + coord_cartesian(ylim = c(1000,30000000))
p <- p + stat_summary(fun = mean, geom = "bar",  position=position_dodge(.9))
p <- p + geom_dotplot(binaxis='y', stackdir='center',  position=position_dodge(.9), dotsize=6.5, stackratio = 1, binwidth=.02) 
p <- p + stat_summary(fun.data=mean_se, geom="errorbar", color="black", size=0.5, width = 0.6, position=position_dodge(.9))
p <- p + scale_y_log10(breaks = c(1000,10000,100000,1000000,10000000),labels = trans_format("log10", math_format(10^.x)),expand = c(0, 0)) 
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, color="black"), text = element_text(size = 24))
p <- p + scale_fill_manual(values = c("gray","orange","darkorange","steelblue2","steelblue3"))
p <- p + annotation_logticks(sides="l", short = unit(.25,"mm"), mid = unit(.5,"mm"),   long = unit(1,"mm"))  
p <- p + labs(title="re-isolated Treg (GvHD)",x="organ", y = "cells per organ")
p <- p + facet_wrap(~organ, nrow=1)
p
pdf("./figures/TregOrganDistSE.pdf", height=5.5, width=9)
p
dev.off()
```

## Statistics

running statistical testing 
homogeneity of variance assumption: levene
normality assumpttion: shapiro
Anova with Tukey

(adding corresponding bars and asterisks to the plot in Adobe Illustrator)

```{r}
Treg.data$category <- factor(Treg.data$category,levels = c("organ_resident","allo_noGvHD","poly_noGvHD","allo_GvHD","poly_GvHD"))
Treg.dataLiver <- Treg.data[ which(Treg.data$organ=='Liver' & (Treg.data$type=='GvHD' | Treg.data$type=='noGvHD')), ]
Treg.dataColon <- Treg.data[ which(Treg.data$organ=='Colon' & (Treg.data$type=='GvHD' | Treg.data$type=='noGvHD')), ]
Treg.dataSpleen <- Treg.data[ which(Treg.data$organ=='Spleen' & (Treg.data$type=='GvHD' | Treg.data$type=='noGvHD')), ]
Treg.dataBM <- Treg.data[ which(Treg.data$organ=='BM' & (Treg.data$type=='GvHD')), ]
Treg.datamLN <- Treg.data[ which(Treg.data$organ=='mLN' & (Treg.data$type=='GvHD')), ]
```

### liver Treg.data

```{r}
leveneTest(count~category, data=Treg.dataLiver, center=mean)  # sign.
shapiro.test(Treg.dataLiver$count[1:6]) 						 # sign.
shapiro.test(Treg.dataLiver$count[7:12])						 # n.s.
shapiro.test(Treg.dataLiver$count[13:19])                      # n.s.
shapiro.test(Treg.dataLiver$count[20:25])                      # n.s.
```

ANOVA assumptions not met. Use Kruskal-Wallis instead

```{r}
kruskal.test(count~category, data=Treg.dataLiver)
```

no significant differences

### spleen Treg.data

```{r}
leveneTest(count~category, data=Treg.dataSpleen, center=mean)  # n.s.
shapiro.test(Treg.dataSpleen$count[1:6]) 						 # n.s.
shapiro.test(Treg.dataSpleen$count[7:12])						 # n.s.
shapiro.test(Treg.dataSpleen$count[13:19])                      # n.s.
shapiro.test(Treg.dataSpleen$count[20:25])                      # n.s.

Treg.spleen.res.aov <- aov(count~category, data=Treg.dataSpleen)
summary (Treg.spleen.res.aov)
```
```{r}
TukeyHSD(Treg.spleen.res.aov)
```

allo_GvHD-allo_noGvHD p<0.01 **



### colon Treg.data

```{r}
leveneTest(count~category, data=Treg.dataColon, center=mean)  # n.s.
shapiro.test(Treg.dataColon$count[1:6]) 						 # n.s.
shapiro.test(Treg.dataColon$count[7:12])						 # n.s.
shapiro.test(Treg.dataColon$count[13:19])                      # n.s.
shapiro.test(Treg.dataColon$count[20:25])                      # n.s.

Treg.colon.res.aov <- aov(count~category, data=Treg.dataColon)
summary (Treg.colon.res.aov)
```
no significant differences

### BM Treg.data

different set up: t-test
check validity first (F-test, Shapiro)
```{r}
var.test(count~category, data=Treg.dataBM, center=mean)  # n.s.
shapiro.test(Treg.dataBM$count[1:4]) 						 # n.s.
shapiro.test(Treg.dataBM$count[5:8])						 # n.s.
```


```{r}
Treg.BM.res.t.test <- t.test(count~category, data=Treg.dataBM, var.equal = TRUE)
Treg.BM.res.t.test
```

no significant differences

### mLN Treg.data

different set up: t-test

```{r}
var.test(count~category, data=Treg.datamLN, center=mean)  # n.s.
shapiro.test(Treg.datamLN$count[1:4]) 						 # n.s.
shapiro.test(Treg.datamLN$count[5:8])						 # n.s.
```


```{r}
Treg.mLN.res.t.test <- t.test(count~category, data=Treg.datamLN, var.equal = TRUE)
Treg.mLN.res.t.test
```




```{r}
sessionInfo(package = NULL)
writeLines(capture.output(sessionInfo(package = NULL)), "./Rscripts/Figure2b_Treg7dafterBMT_inVivoDistribution_SessionInfo.txt")
```