---
title: "FigureXX_SuppressionAssay"
author: Michael Rehli
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::write_bib(.packages(), "FigureRev_SuppressionAssay.packages.bib")
```

# GvHD scores in BMT experiments

R packages

```{r, message=FALSE, warnings=FALSE}
library(ggplot2)
library(scales)
library(tidyverse)
library(Hmisc)
library(ggpubr)
```

data formating 

```{r}
assay.data <- read.delim("./data/SupprAssay.txt", header=TRUE)
assay.data$Div <- factor(assay.data$Div,levels = c("undivided","Div1","Div2","Div3","Div4","Div5"))
assay.data$Type <- factor(assay.data$Type,levels = c("none","allo1:1","poly1:1","allo1:4","poly1:4","allo1:16","poly1:16"))
onetoone <- assay.data %>% filter(Ratio == "none" | Ratio == "01:01")
onetofour <- assay.data %>% filter(Ratio == "none" | Ratio == "01:04")
onetosixteen <- assay.data %>% filter(Ratio == "none" | Ratio == "01:16")
```

**generating the plot for Ratio 1:1**

```{r, fig.width=4.5, fig.height=4.5, warning=FALSE}
p1 <- ggplot(onetoone, aes(x=Div, y=Count, group=Exp, color=Exp)) +
      coord_cartesian(ylim = c(0,80)) +
      stat_summary(fun.data=mean_se, geom="errorbar", size=0.5, width = .25, position="identity") +
      stat_summary(fun = mean, geom = "point", size=2.5, position="identity") +
      stat_summary(fun = mean, geom = "line", size=.5, position="identity") +
      theme_bw() +
      theme(panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), 
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, color="black"), 
            axis.text.y = element_text(color="black"), 
            text = element_text(size = 24),
            legend.title=element_blank()) +
      scale_color_manual(labels = c(none = "no Treg", 
                               allo = "allo Treg", 
                               poly = "poly Treg"), 
                            values = c(none = "black", 
                               allo = "darkorange", 
                               poly = "steelblue3")
                         ) +
      scale_x_discrete(expand = c(0.04,0)) + scale_y_continuous(expand = c(0.02,0)) +
      labs(title="Ratio 1:1",x="Cell divisions", y = "% of Tresp")
p1
```

**generating the plot for Ratio 1:4**

```{r, fig.width=4.5, fig.height=4.5, warning=FALSE}
p2 <- ggplot(onetofour, aes(x=Div, y=Count, group=Exp, color=Exp)) +
      coord_cartesian(ylim = c(0,80)) +
      stat_summary(fun.data=mean_se, geom="errorbar", size=0.5, width = .25, position="identity") +
      stat_summary(fun = mean, geom = "point", size=2.5, position="identity") +
      stat_summary(fun = mean, geom = "line", size=.5, position="identity") +
      theme_bw() +
      theme(panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), 
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, color="black"), 
            axis.text.y = element_text(color="black"), 
            text = element_text(size = 24),
            legend.title=element_blank()) +
      scale_color_manual(labels = c(none = "no Treg", 
                               allo = "allo Treg", 
                               poly = "poly Treg"), 
                            values = c(none = "black", 
                               allo = "darkorange", 
                               poly = "steelblue3")
                         ) +
      scale_x_discrete(expand = c(0.04,0)) + scale_y_continuous(expand = c(0.02,0)) +
      labs(title="Ratio 1:4",x="Cell divisions", y = "% of Tresp")
p2
```


**generating the plot for Ratio 1:16**

```{r, fig.width=4.5, fig.height=4.5, warning=FALSE}
p3 <- ggplot(onetosixteen, aes(x=Div, y=Count, group=Exp, color=Exp)) +
      coord_cartesian(ylim = c(0,80)) +
      stat_summary(fun.data=mean_se, geom="errorbar", size=0.5, width = .25, position="identity") +
      stat_summary(fun = mean, geom = "point", size=2.5, position="identity") +
      stat_summary(fun = mean, geom = "line", size=.5, position="identity") +
      theme_bw() +
      theme(panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), 
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, color="black"), 
            axis.text.y = element_text(color="black"), 
            text = element_text(size = 24),
            legend.title=element_blank()) +
      scale_color_manual(labels = c(none = "no Treg", 
                               allo = "allo Treg", 
                               poly = "poly Treg"), 
                            values = c(none = "black", 
                               allo = "darkorange", 
                               poly = "steelblue3")
                         ) +
      scale_x_discrete(expand = c(0.04,0)) + scale_y_continuous(expand = c(0.02,0)) +
      labs(title="Ratio 1:16",x="Cell divisions", y = "% of Tresp")
p3
```

# Statistics

1. are allo and poly different from noTreg
2. are allo and poly different from each other

run ANOVA with Tukey post-hoc for each division

```{r}
myTukey <- ""
myAnova <- ""
for (i in levels(onetoone$Div)) {
test.data <- onetoone[ which(onetoone$Div==i),]  
test.res.aov <- aov(Count~Exp, data=test.data)
myAnova[i] <- summary(test.res.aov)
myTukey[i] <- TukeyHSD(test.res.aov)
}
```

```{r}
for (i in levels(onetoone$Div)) {
print(c(i, myAnova[i]), row.names = FALSE)
}
```

```{r}
for (i in levels(onetoone$Div)) {
print(c(i, myTukey[i]))
}
```

```{r}
myTukey <- ""
myAnova <- ""
for (i in levels(onetofour$Div)) {
test.data <- onetofour[ which(onetoone$Div==i),]  
test.res.aov <- aov(Count~Exp, data=test.data)
myAnova[i] <- summary(test.res.aov)
myTukey[i] <- TukeyHSD(test.res.aov)
}
```

```{r}
for (i in levels(onetofour$Div)) {
print(c(i, myAnova[i]), row.names = FALSE)
}
```

```{r}
for (i in levels(onetofour$Div)) {
print(c(i, myTukey[i]))
}
```
```{r}
myTukey <- ""
myAnova <- ""
for (i in levels(onetosixteen$Div)) {
test.data <- onetosixteen[ which(onetosixteen$Div==i),]  
test.res.aov <- aov(Count~Exp, data=test.data)
myAnova[i] <- summary(test.res.aov)
myTukey[i] <- TukeyHSD(test.res.aov)
}
```

```{r}
for (i in levels(onetosixteen$Div)) {
print(c(i, myAnova[i]), row.names = FALSE)
}
```

```{r}
for (i in levels(onetosixteen$Div)) {
print(c(i, myTukey[i]))
}
```

None of the allo-poly comparisons were significantly different. But we see a slight trend.



## Arranging the plots for pdf

```{r}
figure <- ggarrange(p1, p2, p3,
                    labels = c("", "", ""),
                    ncol = 3, nrow = 1)
```

```{r}
pdf("./figures/SuppressionAssay.pdf", height=5, width=15)
figure
dev.off()
```



```{r}
sessionInfo(package = NULL)
writeLines(capture.output(sessionInfo(package = NULL)), "./Rscripts/FigureRev_SuppressionAssay_SessionInfo.txt")
```








