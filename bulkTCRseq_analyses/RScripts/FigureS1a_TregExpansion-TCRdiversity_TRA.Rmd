---
title: "FigureS1a_TregExpansion-TCRdiversity_TRA"
author: Michael Rehli
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::write_bib(.packages(), "FigureS1a_TregExpansion-TCRdiversity_TRA.packages.bib")
```

This Rscript is called in the CommandsB07_bulkTCR_TregExpansion.sh script 

## Figure showing TRA TCR diversities of allo and poly Treg expansion cultures compared to d0 Treg isolated from spleen

R packages

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(immunarch)
library(PMCMRplus) 
library(car)
```
**Data loading**

```{r, warning=FALSE, message=FALSE}
file_path = "./MixcrData/Treg_TRA_donors_merged"
immdata <- repLoad(file_path)
```

**Extracting clone counts**

```{r}
exp_umi <- repExplore(immdata$data, .method = "clones")
exp_umi
```

# Calculating diversity (Simpson Index)

```{r}
down <- repSample(immdata$data, .method = "downsample")
sapply(down, nrow)
div_simp <- repDiversity(down, "inv.simp")
div_simp$Type <- c(rep("adonor",6),rep("allo",6),rep("poly",6))
div_simp$Type <- as.factor(div_simp$Type)
div_simp
```

**Statistics**

running statistical testing 
normality assumpttion: shapiro

```{r}
shapiro.test(div_simp$Value[1:6]) 						 # n.s.
shapiro.test(div_simp$Value[7:12])						 # n.s.
shapiro.test(div_simp$Value[13:18])            # n.s.
div_simp.aov <- aov(Value~Type, data=div_simp)
summary (div_simp.aov)
```

```{r}
TukeyHSD(div_simp.aov)
```
                 diff       lwr       upr     p adj
allo-adonor -4627.167 -7156.481 -2097.852 0.0007077
poly-adonor -1013.883 -3543.197  1515.432 0.5634001
poly-allo    3613.284  1083.969  6142.599 0.0055810

## generating the plot for Figure S2a

```{r, fig.width=1.75, fig.height=3}
p <- ggplot(div_simp , aes(Type, Value, fill=Type)) 
p <- p + theme_classic() + theme(panel.grid.major.y = element_line(linetype="dashed", color = "gray")) + theme(legend.position = "none")
p <- p + geom_bar(stat = "summary", fun = "mean", colour="black", size = .5) 
p <- p + scale_fill_manual(values = c("gray50", "orange", "steelblue"))
p <- p + ggtitle("TRA Clonotype\nDiversity",subtitle = "downsampled (n=30K)") + ylim(0,12000)
p <- p + geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(1), dotsize=2.0, colour="black", binwidth=200) 
p <- p + stat_summary(fun.data = mean_se, geom = "errorbar", width=.6)
p <- p + theme(axis.text = element_text(size=12, colour="black"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p <- p + ylab("Inverse Simpson index") + xlab("")

p <- ggplot(div_simp , aes(Type, Value, fill=Type)) +
      theme_classic() + theme(panel.grid.major.y = element_line(linetype="dashed", color = "gray")) + theme(legend.position = "none") +
      geom_bar(stat = "summary", fun = "mean", colour="black", size = .5) +
      scale_fill_manual(values = c("gray50", "orange", "steelblue")) +
      ggtitle("TRA Clonotype\nDiversity",subtitle = "downsampled (n=30K)") + ylim(0,12000) +
      scale_y_continuous(breaks = seq(0, 10000, by = 2000)) +
      geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(1), dotsize=2.0, colour="black", binwidth=200) +
      stat_summary(fun.data = mean_se, geom = "errorbar", width=.6) +
      theme(axis.text = element_text(size=12, colour="black"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      ylab("Inverse Simpson index") + xlab("") +
      annotate("segment", x = 1, y = 9000, xend = 2, yend = 9000) +
      annotate("segment", x = 1, y = 11000, xend = 3, yend = 11000) +
      annotate("segment", x = 2, y = 9500, xend = 3, yend = 9500) +
      annotate("text", x = 1.5, y = 9250, label = "***", size = 4) +
      annotate("text", x = 2, y = 11500, label = "italic('n.s.')", size = 3, parse = TRUE) +
      annotate("text", x = 2.5, y = 9750, label = "**", size = 4)
 

p
pdf(file="./figures/Treg_TRA_donors_merged_diversity_invSimp_30K.pdf", height=3, width=1.75)
p
dev.off()

```

```{r}
sessionInfo(package = NULL)
writeLines(capture.output(sessionInfo(package = NULL)), "FigureS1a_TregExpansion-TCRdiversity_SessionInfo_TRA.txt")
```


