---
title: "Figure6g_Treg_GvHD_examplesCloneDistribution_10x_TRB"
author: Michael Rehli
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::write_bib(.packages(), "Figure6g_Treg_GvHD_examplesCloneDistribution_10x_TRB.packages.bib")
```

This Rscript is called in the Commands_scTCR_GvHD.sh script

# Plot for Figures 6g - Frequency of major clones across tissues


R packages

```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(scales)
library(tidyr)
```

data loading (table containing 6 examples of clone distributions, generated by Commands_scTCR_GvHD.sh)

```{r, warning=FALSE, message=FALSE}
data <- read.delim("./analysis/scTCRxTregDCLS.selected.clonotypeTable.txt", header=TRUE)
df <- data.frame(t(as.matrix(data[-1])))
colnames(df) <- data[,1]
df$type <- c(rep("donor",2), rep("colon",3), rep("liver",3), rep("spleen",3))
df$color <- c(rep("red",2), rep("sienna4",3), rep("skyblue4",3), rep("deeppink",3))

```

subset of three more ubiquitous top clones

```{r}
dfa <- df[,c(1:3,7,8)]
dm <- gather(dfa, key = "TCR", value = "values", "TRAV10D/TRBV13-1", "TRAV16D-DV11/TRBV3", "TRAV4D-4/TRBV15")
dm$type <- factor(dm$type, levels= c('donor','colon','liver','spleen'))
dm$Colorlevels <- factor(dm$color, levels= c("red","sienna4","skyblue4","deeppink"))
dm$TCR <- factor(dm$TCR, levels =c("TRAV10D/TRBV13-1", "TRAV16D-DV11/TRBV3", "TRAV4D-4/TRBV15"))
```


#### generating the bar charts for the top panel of Figure 6g
(will have to remove error bars from donor plots) 

```{r, fig.width=4, fig.height=2.5}
p <- ggplot(dm, aes(x= type, y= values))
p <- p + stat_summary(fun = mean, geom = "bar", position=position_dodge(.9), aes(fill=color))
p <- p + geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(.9), dotsize=4,  stackratio = 1, binwidth=.25,  aes(fill=color), show.legend=T) 
p <- p + stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom="errorbar", color="black", size=0.5, width = 0.6, position=position_dodge(.9))
p <- p + scale_fill_identity(guide = "legend", labels = levels(dm$type), breaks = levels(dm$Colorlevels)) + scale_y_continuous(expand = c(0, 1))
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), text = element_text(size = 12))
p <- p + facet_wrap(~TCR, nrow=1)
p
pdf(file="./figures/cloneDistributionTCRexamples1-3.pdf", height=2.5, width=4)
plot(p)
dev.off()
```

subset of three more tissue restricted top clones

```{r}
dfb <- df[,c(4:8)]
dm <- gather(dfb, key = "TCR", value = "values", "TRAV1/TRBV26", "TRAV13D-1/TRBV19", "TRAV10/TRBV12-2")
dm$type <- factor(dm$type, levels= c('donor','colon','liver','spleen'))
dm$Colorlevels <- factor(dm$color, levels= c("red","sienna4","skyblue4","deeppink"))
dm$TCR <- factor(dm$TCR, levels =c("TRAV1/TRBV26", "TRAV10/TRBV12-2", "TRAV13D-1/TRBV19"))
```


#### generating the bar charts for the bottom panel of Figure 6g
(will have to remove error bars from donor plots) 

```{r, fig.width=4, fig.height=2.5}
p <- ggplot(dm, aes(x= type, y= values))
p <- p + stat_summary(fun = mean, geom = "bar", position=position_dodge(.9), aes(fill=color))
p <- p + geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(.9), dotsize=2.4,  stackratio = 1, binwidth=.25,  aes(fill=color), show.legend=T) 
p <- p + stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom="errorbar", color="black", size=0.5, width = 0.6, position=position_dodge(.9))
p <- p + scale_fill_identity(guide = "legend", labels = levels(dm$type), breaks = levels(dm$Colorlevels)) + scale_y_continuous(expand = c(0, 1))
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), text = element_text(size = 12))
p <- p + facet_wrap(~TCR, nrow=1)
p
pdf(file="./figures/cloneDistributionTCRexamples4-6.pdf", height=2.5, width=4)
plot(p)
dev.off()
```


```{r}
sessionInfo(package = NULL)
writeLines(capture.output(sessionInfo(package = NULL)), "Figure6g_Treg_GvHD_examplesCloneDistribution_10x_TRB_SessionInfo.txt")
```


