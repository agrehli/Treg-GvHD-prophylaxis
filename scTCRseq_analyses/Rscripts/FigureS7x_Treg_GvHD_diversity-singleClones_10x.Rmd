---
title: "FigureS7x_Treg_GvHD_diversity-singleClones_10x"
author: Michael Rehli
output: 
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::write_bib(.packages(), "FigureS7x_Treg_GvHD_diversity-singleClones_10x.packages.bib")
```

This Rscript is called in the Commands_scTCR_GvHD.sh script

# Data analysis for Figures 6x and 6y (Labels need to be adjusted)


R packages

```{r, warning=FALSE, message=FALSE}
library("immunarch")
library("ggalluvial")
library("ggpubr")
library("RColorBrewer")
```

data loading

```{r, warning=FALSE, message=FALSE}
file_path = "/misc/data/analysis/project_TregProphylaxis/scTCRrepertoire/colonCellRangerData"
file_path = "./colonCellRangerData"
immdata <- repLoad(file_path, .mode = "paired")
```

extracting clone counts

```{r}
exp_umi <- repExplore(immdata$data, .method = "clones")
exp_umi
```

## TCR Diversity

calculating diversity (Simpson Index) across clusters 1-5
(smaller clusters would require to much down-sampling)

```{r}
set.seed(42)
down <- repSample(immdata$data[c(1:5, 9:13, 17:21)], .method = "downsample")
sapply(down, nrow)
div_simp <- repDiversity(down, "inv.simp")
div_simp$Type <- immdata$meta$Type[c(1:5, 9:13, 17:21)]
div_simp
```

generating the plot for Figure S7X (will remove the error bar in the donor samples, just two samples!)

```{r, fig.width=3, fig.height=3}
p <- ggplot(div_simp , aes(Type, Value, fill=Type)) 
p <- p + theme_classic() + theme(panel.grid.major.y = element_line(linetype="dashed", color = "gray")) + theme(legend.position = "none")
p <- p + geom_bar(stat = "summary", fun = "mean", colour="black", size = .5) 
p <- p + scale_fill_manual(values = c("#F8766D", "#CD9600", "#7CAE00", "#00BE67", "#00BFC4"))
p <- p + ggtitle("Clonotype\nDiversity",subtitle = "downsampled (n=576)") + ylim(0,800)
p <- p + geom_dotplot(binaxis='y', stackdir='center', position=position_dodge(1), dotsize=.5, colour="black", binwidth=50) 
p <- p + stat_summary(fun.data = mean_se, geom = "errorbar", width=.6)
p <- p + theme(axis.text = element_text(size=12, colour="black"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p <- p + ylab("Inverse Simpson index") + xlab("")
p
```
```{r}
pdf(file="./figures/scTCRxTregColonCluster1-5_diversity_invSimp_576.pdf", height=3, width=3)
p
dev.off()
```
```{r}

```



## clonal overlap

all clusters, three metices

```{r , fig.width=5, fig.height=5}
imm_ov1 <- repOverlap(immdata$data, .method = "public", .verbose = F)
imm_ov2 <- repOverlap(immdata$data, .method = "morisita", .verbose = F)
imm_ov3 <- repOverlap(immdata$data, .method = "jaccard", .verbose = F)
vis(imm_ov1, "heatmap2", .title = "Public Overlap")
vis(imm_ov2, "heatmap2", .title = "Morisita's Overlap Index")
vis(imm_ov3, "heatmap2", .title = "Jaccard index")
```

```{r}
pdf(file="./figures/scTCRxTregColonClusters_overlapPublic.pdf", height=5, width=5.4)
vis(imm_ov1, "heatmap2", .title = "Public Overlap")
dev.off()
pdf(file="./figures/scTCRxTregColonClusters_overlapMorisita.pdf", height=5, width=5.4)
vis(imm_ov2, "heatmap2", .title = "Morisita's Overlap Index")
dev.off()
pdf(file="./figures/scTCRxTregColonClusters_overlapJaccard.pdf", height=5, width=5.4)
vis(imm_ov3, "heatmap2", .title = "Jaccard index")
dev.off()
```

same with clusters 1-5 only

```{r , fig.width=5, fig.height=5}
imm_ov4 <- repOverlap(immdata$data[c(1:5, 9:13, 17:21)], .method = "public", .verbose = F)
imm_ov5 <- repOverlap(immdata$data[c(1:5, 9:13, 17:21)], .method = "morisita", .verbose = F)
imm_ov6 <- repOverlap(immdata$data[c(1:5, 9:13, 17:21)], .method = "jaccard", .verbose = F)
vis(imm_ov4, "heatmap2", .title = "Public Overlap")
vis(imm_ov5, "heatmap2", .title = "Morisita's Overlap Index")
vis(imm_ov6, "heatmap2", .title = "Jaccard index")
```
```{r}
pdf(file="./figures/scTCRxTregColonClusters_overlapPublic_cluster1-5.pdf", height=5, width=5.4)
vis(imm_ov4, "heatmap2", .title = "Public Overlap")
dev.off()
pdf(file="./figures/scTCRxTregColonClusters_overlapMorisita_cluster1-5.pdf", height=5, width=5.4)
vis(imm_ov5, "heatmap2", .title = "Morisita's Overlap Index")
dev.off()
pdf(file="./figures/scTCRxTregColonClusters_overlapJaccard_cluster1-5.pdf", height=5, width=5.4)
vis(imm_ov6, "heatmap2", .title = "Jaccard index")
dev.off()
```




## tracking major clones across replicates

hand-selected list of top 20 clones

```{r}
clonotypes <- read.delim("./topFrequentClonotypesColon.txt", header=TRUE)
tc <- trackClonotypes(immdata$data, clonotypes[1:10,], .col = "aa+v")
tc <- tc %>% arrange(factor(CDR3.aa, levels=clonotypes$CDR3.aa))
```

### create barplot for top 10 clones 

immunarch doesn't allow to sort the clonotypes (just uses them in alphabetical order)
recreated plot with right levels set for clonotypes
prepare data

```{r}
ordered_sample_names <- order(immdata$meta$Type)
melted <- melt(tc, id.vars = c("CDR3.aa", "V.name")) %>% lazy_dt() %>% rename(Count = value, Sample = variable) %>% collect()
setDT(melted)
y_lab_title <- "Proportion"
sample_names <- unique(melted$Sample)
ordered_sample_names <- sample_names[order(substr(sample_names, 16, 16))]
melted <- melted[melted$Sample %in% ordered_sample_names, ]
melted$Sample <- factor(melted$Sample, levels = ordered_sample_names, ordered = TRUE)
column_names <- names(melted)[1:2]
melted[, Clonotype := do.call(paste, .SD), .SDcols = column_names]
melted$Count <- melted$Count + min(melted$Count[melted$Count != 0]) / 1000
clonotype_names <- unique(melted$Clonotype)
melted$Clonotype <- factor(melted$Clonotype, levels = clonotype_names, ordered = TRUE)
```
plotting

```{r, fig.width=10, fig.height=5}
p <- ggplot(melted, aes(x = Sample, fill = Clonotype, stratum = Clonotype,
    alluvium = Clonotype, y = Count, label = Clonotype ))
p <- p + geom_flow() + geom_stratum()
p <- p + ylab(y_lab_title) + scale_fill_brewer(palette = "RdYlBu")
p <- p + ggtitle("Top 10 Clonotypes")
p <- p + theme_pubr(legend = "right") + rotate_x_text(90)
p <- p + theme( panel.grid.major.y = element_line(colour = "grey70", linetype = "dashed"), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())
p
```

```{r}
pdf(file="./figures/scTCRxTregColonCluster_10topclones.pdf", height=5, width=10)
p
dev.off()
```


original code (not used)
```{r, fig.width=5, fig.height=12}
#vis(tc)
#sample_order <- order(immdata$meta$Type)
#pdf(file="./figures/scTCRxTregColonCluster10_topclones_ia.pdf", height=5, width=10)
#vis(tc, .order = sample_order)
#dev.off()
```



```{r}
sessionInfo(package = NULL)
writeLines(capture.output(sessionInfo(package = NULL)), "FigureS7x_Treg_GvHD_diversity-singleClones_10x_SessionInfo.txt")
```


